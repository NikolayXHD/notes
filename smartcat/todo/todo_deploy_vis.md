# Постановка задачи

Настроить развёртывание [Сервиса индексации векторов](http://gitlab.sc.local/ml/vector-index/vector-indexing-service)

Целевые окружения

* Прод europe
* Stage-next

Критерии успеха

* Развёрнут компонент поиска
* Развернут компонент индексации
* Развёрнуто и подключено к обоим компоненам общее файловое хранилище типа EBS
  storage

Докер образы

В качестве руководящего примера, в репозитории настроена сборка докер-образов.
Команды сборки:

```
$ make docker-build-indexer
$ make docker-build-search
```

# Аппаратные требования

## компонент поиска

* RAM 32GB
* CPU 4 ядра, возможно увеличение в будущем
* 2 одновременно работающих копии инстанса, для отказоустойчивости
* сетевая доступность
  * входящие запросы - только сервис TSS
  * исходящих запросов нет
  * внешний том `/data/storage`

## Компонент индексации

* RAM 8GB
* CPU 8 ядер, возможно увеличение в будущем
* клон для отказоустойчивости не требуется
* сетевая доступность
  * входящие запросы - только сервис TSS
  * исходящих запросов нет
  * внешний том `/data/storage`

## Файловое хранилище

Компоненты должны использовать общее файловое хранилище индексов, для этого
в докер-образах предусмотрен внешний том `VOLUME /data/storage`

Физически, хранилище должно представлять из себя EBS storage.

На проде

* RAID0 из 4х SSD дисков типа gp3
* Суммарный объём 400 GB

На stage-next

* 1 диск gp3, без RAID0
* объём 64 GB

Для обеспечения траффика между EBS-хранилищем и сервисом, компоненты сервиса
должены быть развёрнуты на EBS-optimized инстансах. По дефолту, не устаревшие
типы инстансов amazon уже являются EBS-optimized, см.
https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-optimized.html

## Резервирование IOPS

Производительность EBS хранилища критически влияет на проивзодительность всего
сервиса. Согласно документации AWS, для поддержания IOPS 16.000 на 1 диск,
необходимо отдельно оплачивать резервирование IOPS

См https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/general-purpose.html#gp3-performance

На первом этапе (в рамках этой задачи) мы не оплачиваем резервирование IOPS,
но нужно быть готовым к тому, что команда @team_ml_dev будет мониторить
производительность сервиса, и в скором будущем поставит задачу на использование
платного резервирования IOPS на проде.

В тестовой среде, stage-next, резервирование IOPS не требуется.

# Конфигурация

В репозитории образец файла конфигурации лежит в директории `.config`

## Разница между prod и stage-next

При деплое на stage-next и prod-europe должны использоваться разные конфиги,
т.к. объём хранилища сильно различается. Путь к конфигу передаётся
параметром `--storage-config` при запуске компонента.

## Секреты

На текущий момент, конфигурация не содержит секретов, но они появятся, когда
будет реализована CSMS-26546. Будет конфиг с учётными данными AWS S3, путь
к конфигу будет передаваться параметром `--s3-config` в компонент индексации.

# Логи

Оба компонента пишут логи в stderr в формате json, максимально приближенному
к другим сервисам smartcat.

* Должен быть настроен импорт логов обоих компонентов в kibana

# Метрики

* Должен быть настроен сбор метрик входящих запросов в оба компонента. Метрик
  должно быть достаточно, чтобы оценивать не менее чем за 1 последнюю неделю
  * Количество входящих запросов
  * Квантили задержки на получение ответа, другими словами время обработки
  * Величина входящего траффика
  * Величина исходящего траффика (ответы на запросы)

# Алерты

В случае проблем, уведомлять в slack чат #team-ml-notification с упоминанием
@team_ml_dev.

Признаки проблем

* `GET /stats` компонента индексации
  * не отвечает
  * признак `hanging_alert: true` в теле ответа
  * признак `low_free_space_alert: true` в теле ответа
* `GET /stats` компонента поиска
  * не отвечает
  * признак `low_memory_alert: true` в теле ответа

Опрашивать `GET /stats` не чаще раза в 1 минуту, чтобы не создавать лишнюю
нагрузку на хранилище. Если возникнет потребность в более частых liveness
запросах, для этого подходит `GET /ping`.

# Порядок реализации

Первым делом, настраиваем деплой в тестовое окружение stage-next, ибо тяжело в
учении, легко в бою.
